# Scripts

Utility scripts for database management, data reconciliation, and integrations.

## Directory Structure

```
scripts/
├── reconciliation/     # Data reconciliation and import scripts
├── guides/             # Documentation and planning guides
├── sql/                # SQL scripts for database operations
├── migrations/         # Generated migration scripts
└── test-data/          # Test data for development
```

---

## Reconciliation Scripts

Scripts for importing data and fixing data inconsistencies.

### `reconciliation/import-woocommerce-orders.ts`

Imports orders from WooCommerce via CSV into the database. Creates order, order items, payments, invoices, and company team records.

```bash
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/import-woocommerce-orders.ts [csv-file]
```

**CSV Templates:**
- `import-orders-template.csv` - Template with column headers
- `orders-sportsfest.csv` - Sample data

### `reconciliation/sync-missing-company-teams.ts`

Creates missing `companyTeam` records for organizations that have purchased teams but don't have corresponding team records. Useful after imports or to fix historical data.

```bash
# Dry run first
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/sync-missing-company-teams.ts --dry-run

# Run for real
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/sync-missing-company-teams.ts
```

### `reconciliation/fix-order-balance-owed.ts`

Fixes orders with `status = 'fully_paid'` that still have a non-zero `balanceOwed` value. This corrects revenue calculation discrepancies.

```bash
# Dry run first
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/fix-order-balance-owed.ts --dry-run

# Run for real
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/fix-order-balance-owed.ts
```

### `reconciliation/fix-duplicate-payments.ts`

Finds and removes duplicate payment records caused by a race condition between the frontend confirm-payment route and Stripe webhook. Keeps the oldest payment record and recalculates invoice amounts.

```bash
# Dry run first
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/fix-duplicate-payments.ts --dry-run

# Run for real
DATABASE_URL="postgresql://..." npx tsx scripts/reconciliation/fix-duplicate-payments.ts
```

---

## Standalone Scripts

### `cleanup-orders.mjs`

Cleans up test/orphaned orders from the database.

### `setup-constant-contact-oauth.js`

Sets up OAuth authentication for Constant Contact email integration.

### `init-constant-contact-token.js`

Initializes the Constant Contact API token after OAuth setup.

### `analyze-warnings.js`

Analyzes Supabase warnings from exported JSON files.

### `generate-rls-fix-from-export.js`

Generates SQL to fix Row Level Security (RLS) policies based on exported Supabase warnings.

---

## SQL Scripts (`sql/`)

SQL scripts for database operations. Run these directly in Supabase SQL Editor or via `psql`.

| Script | Purpose |
|--------|---------|
| `audit-database-for-launch.sql` | Pre-launch database audit queries |
| `production-launch-cleanup.sql` | Production cleanup before launch |
| `diagnose-organization-data.sql` | Diagnose organization data issues |
| `diagnose-organization-data-v2.sql` | Updated diagnostic queries |
| `clear-organization-rosters.sql` | Clear roster data for an organization |
| `clear-organization-rosters-preview.sql` | Preview what would be cleared |
| `delete-organization-current-year-data.sql` | Delete org's current year data |
| `move-organization-to-previous-year.sql` | Move org data to previous event year |
| `move-organization-to-previous-year-preview.sql` | Preview the move operation |
| `move-organization-complete.sql` | Complete organization data migration |
| `fix-tent-tracking-limits.sql` | Fix tent tracking limit calculations |

---

## Guides (`guides/`)

Documentation and planning guides for database operations.

| Guide | Purpose |
|-------|---------|
| `PRODUCTION-CLEANUP-README.md` | Production cleanup procedures |
| `README-RLS-FIXES.md` | Row Level Security fix documentation |
| `database-launch-prep-plan.md` | Database preparation for launch |
| `dev-database-sync-strategy.md` | Dev/prod database sync strategy |
| `supabase-warnings-cleanup-plan.md` | Plan for addressing Supabase warnings |

---

## Migrations (`migrations/`)

Generated migration scripts for RLS policy fixes. These are auto-generated by `generate-rls-fix-from-export.js`.

---

## Data Files

### `supabase-policies-full.json`

Export of all Supabase RLS policies for reference.

### `supabase-warnings.json`

Export of Supabase security warnings for analysis.

---

## Usage Notes

1. **Always use `--dry-run` first** for reconciliation scripts to preview changes
2. **Set DATABASE_URL** as an environment variable before running TypeScript scripts
3. **Backup your database** before running any data modification scripts
4. Scripts use the database schema from `packages/database/src/schema`
